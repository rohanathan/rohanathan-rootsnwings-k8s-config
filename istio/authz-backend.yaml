# Authorization Policy for backend with dedicated service accounts
apiVersion: security.istio.io/v1beta1
kind: AuthorizationPolicy
metadata:
  name: backend-allow-frontend-ingress
  namespace: backend
spec:
  selector:
    matchLabels:
      app: backend  # Targets only backend pods
  action: ALLOW
  rules:
  # Rule 1: Allow traffic from frontend service account ONLY
  - from:
    - source:
        principals: ["cluster.local/ns/backend/sa/frontend-ksa"]
    to:
    - operation:
        methods: ["GET", "POST", "PUT", "DELETE", "PATCH"]
        
  # Rule 2: Allow traffic from Istio Ingress Gateway
  - from:
    - source:
        namespaces: ["istio-system"]
        principals: ["cluster.local/ns/istio-system/sa/*"]
    to:
    - operation:
        methods: ["GET", "POST", "PUT", "DELETE", "PATCH"]
        
  # Rule 3: Allow health checks (Kubernetes probes don't have mTLS identity)
  - to:
    - operation:
        paths: ["/health", "/ready", "/healthz", "/livez"]
        methods: ["GET"]